# author:      Erik Sohns <@MAINTAINER_EMAIL_ADDRESS@>
# rpm spec file

AutoReqProv:  yes
BuildRoot:    %{_tmppath}/%{name}-root
Distribution: N/A
Group:        Applications/Tools
#Icon: N/A
License:      GPL
Name:         @PACKAGE_NAME@
Packager:     Erik Sohns <@MAINTAINER_EMAIL_ADDRESS@>
Prefix:       /usr/local
Provides:     %{name}
Release:      1
Requires:     libCommon libACEStream libACENetwork
#Serial:       1
Source:       %{name}-%{version}.tar.gz
Summary:      OLinuxIno MOD MPU6050 kernel driver unit test
URL:          @PACKAGE_URL@
Vendor:       N/A
Version:      @VERSION@

%description
kernel driver and (graphical) test tool for the OlinuxIno MPU6050 module

%prep
#rm -rf %{_topdir}/BUILD/*
%setup -q

%build
PROJECT_ROOT_MODULES=/mnt/win_d/projects
%if %{?project_root:1}0
  PROJECT_ROOT_MODULES=%{project_root}/modules
%endif

#rm -rf modules/ACE
#[ $? -ne 0 ] && echo "ERROR: failed to rm modules/ACE, aborting" && exit 1
ACE_ROOT=$PROJECT_ROOT_MODULES/ACE
[ ! -d $ATCD_ROOT ] && echo "ERROR: ATCD project not found, aborting" && exit 1
ln -s  $ATCD_ROOT modules/ACE
[ $? -ne 0 ] && echo "ERROR: failed to link ATCD project, aborting" && exit 1

#rm -rf modules/Common
#[ $? -ne 0 ] && echo "ERROR: failed to rm modules/Common, aborting" && exit 1
COMMON_ROOT=$PROJECT_ROOT_MODULES/Common
[ ! -d $LIBCOMMON_ROOT ] && echo "ERROR: Common project not found, aborting" && exit 1
ln -s  $LIBCOMMON_ROOT modules/Common
[ $? -ne 0 ] && echo "ERROR: failed to link Common project, aborting" && exit 1

#rm -rf modules/ACEStream
#[ $? -ne 0 ] && echo "ERROR: failed to rm modules/ACEStream, aborting" && exit 1
ACESTREAM_ROOT=$PROJECT_ROOT_MODULES/ACEStream
[ ! -d $ACESTREAM_ROOT ] && echo "ERROR: ACEStream project not found, aborting" && exit 1
ln -s  $ACESTREAM_ROOT modules/ACEStream
[ $? -ne 0 ] && echo "ERROR: failed to link ACEStream project, aborting" && exit 1

#rm -rf modules/ACENetwork
#[ $? -ne 0 ] && echo "ERROR: failed to rm modules/ACENetwork, aborting" && exit 1
ACENETWORK_ROOT=$PROJECT_ROOT_MODULES/ACENetwork
[ ! -d $ACENETWORK_ROOT ] && echo "ERROR: ACENetwork project not found, aborting" && exit 1
ln -s  $ACENETWORK_ROOT modules/ACENetwork
[ $? -ne 0 ] && echo "ERROR: failed to link ACENetwork project, aborting" && exit 1

#./autogen.sh

#cd test_i/scripts
#./scanner.sh
#[ $? -ne 0 ] && echo "ERROR: failed to generate scanner, aborting" && exit 1
#./parser.sh
#[ $? -ne 0 ] && echo "ERROR: failed to generate parser, aborting" && exit 1
#cd ../..

%configure
make %{?_smp_mflags}

%install
#rm -rf %{buildroot} # redundant except for RHEL 5
%make_install
# *PORTABILITY*: this is highly platform-specific
mkdir /var/log/@PACKAGE_NAME@
[ $? -ne 0 ] && echo "ERROR: failed to mkdir \"@PACKAGE_NAME@\", aborting" && exit 1
# *TODO*: specify package owner/group ?
chmod go+w /var/log/@PACKAGE_NAME@
[ $? -ne 0 ] && echo "ERROR: failed to chmod \"@PACKAGE_NAME@\", aborting" && exit 1
#%makeinstall
#libtool --finish /usr/lib64

%clean
rm -rf %{buildroot}

%pre
%post -p /sbin/ldconfig
%verifyscript

%preun
%postun -p /sbin/ldconfig

%files
%defattr(-, root, root)
%doc AUTHORS ChangeLog INSTALL LICENSE NEWS README.md TODO
%{_bindir}/*
%{_includedir}/*
%{_libdir}/*
%{_datadir}/%{name}/*

%changelog
